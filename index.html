<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blur Random Words</title>
    <style>
        body {
            font-family: 'Georgia', serif;
            text-align: center;
            padding: 20px;
            height: 100%;
            margin: 0;
            background-color: #0c0c0c;
            color: #ffffff;
        }
        .hidden {
            display: none;
        }
        .lyrics-container {
            display: inline-block;
            text-align: left;
            font-size: 1.5em;
            line-height: 1.6;
            background: #1c1c1c;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
            max-width: 800px;
            height: calc(100% - 150px);
            overflow-y: auto;
            white-space: pre-wrap;
            position: relative;
        }
        .blurred {
            filter: blur(5px);
            transition: filter 0.5s ease-in-out;
        }
        .unblurred {
            filter: blur(0);
            transition: filter 0.5s ease-in-out;
        }
        .correct {
            color: #00ff00;
        }
        .correct-indicator {
            font-size: 0.8em;
            border: 1px solid #00ff00;
            padding: 4px 6px;
            border-radius: 3px;
            float: right;
        }
        button {
            margin-top: 10px;
            padding: 10px 15px;
            font-size: 1em;
            border: none;
            background: #5e5eff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #3b3bff;
        }
        textarea {
            width: 90%;
            max-width: 800px;
            height: 500px;
            margin-top: 15px;
            padding: 10px;
            font-size: 1.2em;
            border: 1px solid #ccc;
            border-radius: 5px;
            resize: none;
            background-color: #2a2a2a;
            color: #e0e0e0;
        }
        /* Container for the difficulty buttons */
        #blurButtons {
            margin-top: 10px;
        }
        .line {
            display: block;
            transition: filter 0.5s ease-in-out;
            padding: 5px 0;
        }
        .highlight {
            position: absolute;
            width: 100%;
            height: 3px;
            background: #FF33FF;
            left: 0;
            top: 60px;
            transform: translateY(-1.5em);
            transition: transform 0.3s ease-in-out;
        }
        .party-background {
            background: linear-gradient(to right, #6a0dad, #a020f0, #5c4d7a);
            background: linear-gradient(to bottom, #6A0DAF, #A020F0);
        }
        .button-primary {
            background-color: #5E5EFF;
            color: #FFFFFF;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            transition: background 0.3s;
        }
    </style>
</head>
<body class="party-background">
<!-- Input Phase -->
<div id="input-phase">
    <textarea id="inputLyrics" placeholder="Enter your lyrics here..."></textarea>
    <!-- Difficulty buttons replacing the slider -->
    <div id="blurButtons">
        <button class="button-primary" onclick="startBlurring('easy')">Easy</button>
        <button class="button-primary" onclick="startBlurring('medium')">Medium</button>
        <button class="button-primary" onclick="startBlurring('hard')">Hard</button>
        <button class="button-primary" onclick="startBlurring('blind')">Blind</button>
    </div>
</div>
<!-- Blurred Phase -->
<div id="blurred-phase" class="hidden">
    <div class="lyrics-container" id="lyrics-container">
        <div id="lyrics"></div>
        <div class="highlight" id="highlight"></div>
    </div>
    <br>
    <button class="button-primary" onclick="goBack()">Go Back</button>
</div>
<script>
    // Global variables
    let currentLineIndex = -1; // Start above the first line
    let lines = [];
    let correctCount = 0;      // Count of correctly marked lines
    let spaceHeld = false;     // True if the space bar is held
    let navDirection = 0;      // 1 for S (down), -1 for W (up)

    // Process the input lyrics, apply blur based on difficulty, and switch phases.
    function startBlurring(difficulty) {
        let inputText = document.getElementById("inputLyrics").value;
        if (inputText.trim() === "") {
            alert("Please enter lyrics before blurring.");
            return;
        }

        // Determine blur percentage based on difficulty.
        let blurPercent;
        if (difficulty === "easy") {
            // Random integer between 20 and 40.
            blurPercent = Math.floor(Math.random() * (40 - 20 + 1)) + 20;
        } else if (difficulty === "medium") {
            blurPercent = Math.floor(Math.random() * (60 - 40 + 1)) + 40;
        } else if (difficulty === "hard") {
            blurPercent = Math.floor(Math.random() * (80 - 60 + 1)) + 60;
        } else if (difficulty === "blind") {
            blurPercent = 100;
        }

        correctCount = 0;
        lines = inputText.split("\n");
        let processedLines = lines.map(line => {
            // Split the line while preserving spaces.
            let words = line.split(/(\s+)/);
            // Collect indices of non-space tokens.
            let nonSpaceIndices = [];
            for (let i = 0; i < words.length; i++) {
                if (words[i].trim() !== "") {
                    nonSpaceIndices.push(i);
                }
            }
            let totalWords = nonSpaceIndices.length;
            // Calculate how many words to blur.
            let numBlurred = Math.floor(totalWords * (blurPercent / 100));
            // Shuffle the indices array.
            let shuffledIndices = nonSpaceIndices.sort(() => Math.random() - 0.5);
            // Choose the first numBlurred indices.
            let indicesToBlur = shuffledIndices.slice(0, numBlurred);
            // Wrap the chosen words in the blurred span.
            indicesToBlur.forEach(index => {
                words[index] = `<span class="blurred">${words[index]}</span>`;
            });
            return `<span class="line">${words.join("")}</span>`;
        });
        document.getElementById("lyrics").innerHTML = processedLines.join("<br>");
        currentLineIndex = -1;
        updateHighlightPosition();
        // Switch to the Blurred Phase.
        document.getElementById("input-phase").classList.add("hidden");
        document.getElementById("blurred-phase").classList.remove("hidden");
        document.addEventListener("keydown", handleKeyPress);
        document.addEventListener("keyup", handleKeyUp);
    }

    // Return to the input phase.
    function goBack() {
        document.getElementById("input-phase").classList.remove("hidden");
        document.getElementById("blurred-phase").classList.add("hidden");
        document.removeEventListener("keydown", handleKeyPress);
        document.removeEventListener("keyup", handleKeyUp);
    }

    // Handle keydown events.
    function handleKeyPress(event) {
        // Prevent auto-repeat for space, s, and w.
        if ((event.key === " " || event.key === "s" || event.key === "w") && event.repeat) {
            event.preventDefault();
            return;
        }

        if (event.key === "s") {
            event.preventDefault();
            if (navDirection === 0) {
                navDirection = 1;
                unblurCurrentLine();
            }
        } else if (event.key === "w") {
            event.preventDefault();
            if (navDirection === 0) {
                navDirection = -1;
                unblurCurrentLine();
            }
        } else if (event.key === " ") {
            event.preventDefault();
            if (!spaceHeld) {
                spaceHeld = true;
                unblurCurrentLine();
            }
        } else if (event.key === "Enter") {
            event.preventDefault();
            let lineElements = [...document.querySelectorAll(".line")].filter(line => line.innerText);
            if (currentLineIndex >= 0 && currentLineIndex < lineElements.length) {
                let currentLine = lineElements[currentLineIndex];
                // Process Enter only if the current line is fully unblurred.
                if (!currentLine.querySelector('.blurred')) {
                    markCurrentLineCorrect();
                    moveHighlight(1);
                    // Reset spaceHeld so that keyup doesn't move an extra line.
                    if (spaceHeld) {
                        spaceHeld = false;
                    }
                }
            }
        }
    }

    // Handle keyup events.
    function handleKeyUp(event) {
        if (event.key === " ") {
            if (spaceHeld) {
                moveHighlight(1);
                spaceHeld = false;
            }
        } else if (event.key === "s") {
            if (navDirection === 1) {
                moveHighlight(1);
                navDirection = 0;
            }
        } else if (event.key === "w") {
            if (navDirection === -1) {
                moveHighlight(-1);
                navDirection = 0;
            }
        }
    }

    // Moves the highlight up or down.
    function moveHighlight(direction) {
        let lineElements = [...document.querySelectorAll(".line")].filter(line => line.innerText);
        if (currentLineIndex + direction >= -1 && currentLineIndex + direction < lineElements.length) {
            currentLineIndex += direction;
            updateHighlightPosition();
        }
    }

    // Unblurs the words in the currently highlighted line.
    function unblurCurrentLine() {
        let lineElements = [...document.querySelectorAll(".line")].filter(line => line.innerText);
        if (currentLineIndex >= 0 && currentLineIndex < lineElements.length) {
            lineElements[currentLineIndex].querySelectorAll(".blurred").forEach(word => {
                word.classList.remove("blurred");
                word.classList.add("unblurred");
            });
        }
    }

    // Updates the position of the highlight bar.
    function updateHighlightPosition() {
        let lineElements = [...document.querySelectorAll(".line")].filter(line => line.innerText);
        let lyricsContainer = document.getElementById("lyrics-container");
        let highlight = document.getElementById("highlight");
        if (currentLineIndex === -1) {
            highlight.style.transform = `translateY(-1.5em)`;
            lyricsContainer.scrollTop = 0;
        } else if (lineElements.length > 0) {
            let targetLine = lineElements[currentLineIndex];
            let offset = targetLine.offsetTop - lyricsContainer.offsetTop;
            highlight.style.transform = `translateY(${offset}px)`;
            window.scrollTo({
                top: targetLine.offsetTop - 200,
                left: 0,
                behavior: "smooth",
            });
        }
    }

    // Toggles the current line's "correct" state and updates the overall percentage.
    function markCurrentLineCorrect() {
        let lineElements = [...document.querySelectorAll(".line")].filter(line => line.innerText);
        if (currentLineIndex >= 0 && currentLineIndex < lineElements.length) {
            let currentLine = lineElements[currentLineIndex];
            // Only toggle if the line is fully unblurred.
            if (currentLine.querySelector('.blurred')) {
                return;
            }
            if (currentLine.classList.contains("correct")) {
                currentLine.classList.remove("correct");
                let indicator = currentLine.querySelector(".correct-indicator");
                if (indicator) {
                    indicator.remove();
                }
                correctCount--;
            } else {
                currentLine.classList.add("correct");
                correctCount++;
                let totalLines = lineElements.length;
                let percentage = Math.round((correctCount / totalLines) * 100);
                let indicatorSpan = document.createElement("span");
                indicatorSpan.classList.add("correct-indicator");
                indicatorSpan.innerHTML = `<strong>${percentage}%</strong>`;
                currentLine.appendChild(indicatorSpan);
            }
        }
    }
</script>
</body>
</html>
